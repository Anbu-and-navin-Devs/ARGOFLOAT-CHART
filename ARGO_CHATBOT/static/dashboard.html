<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | FloatChart</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="FloatChart analytics dashboard">
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåä</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <style>
        /* Dashboard-specific styles */
        .dashboard-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-primary);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .dashboard-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .dashboard-logo span {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: var(--bg-elevated);
            color: var(--accent-primary);
        }
        
        .dashboard-content {
            flex: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .dashboard-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .overview-card {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .overview-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
        }
        
        .overview-card.temp::before { background: linear-gradient(90deg, #ef4444, #f97316); }
        .overview-card.sal::before { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
        .overview-card.floats::before { background: linear-gradient(90deg, #22c55e, #10b981); }
        .overview-card.depth::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
        
        .overview-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .overview-card.temp .overview-icon { background: rgba(239, 68, 68, 0.15); }
        .overview-card.sal .overview-icon { background: rgba(59, 130, 246, 0.15); }
        .overview-card.floats .overview-icon { background: rgba(34, 197, 94, 0.15); }
        .overview-card.depth .overview-icon { background: rgba(139, 92, 246, 0.15); }
        
        .overview-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .overview-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .overview-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .overview-change.positive { color: #22c55e; }
        .overview-change.negative { color: #ef4444; }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .chart-container {
            height: 280px;
            position: relative;
        }
        
        /* Recent Activity */
        .activity-section {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
        }
        
        .activity-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }
        
        .activity-item:hover {
            background: var(--bg-hover);
        }
        
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: var(--bg-secondary);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 0.875rem;
            color: var(--text-primary);
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Coverage Map Placeholder */
        .coverage-section {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .coverage-map {
            height: 300px;
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .dashboard-content {
                padding: 1rem;
            }
            
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .overview-value {
                font-size: 1.5rem;
            }
        }
        
        /* Loading skeleton animation */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-elevated) 25%,
                var(--bg-hover) 50%,
                var(--bg-elevated) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="dashboard-layout">
        <!-- Header -->
        <header class="dashboard-header">
            <a href="/" class="dashboard-logo">
                üåä <span>FloatChart</span>
            </a>
            
            <nav class="dashboard-nav">
                <a href="/" class="nav-link">Chat</a>
                <a href="/map" class="nav-link">Map Explorer</a>
                <a href="/dashboard" class="nav-link active">Dashboard</a>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </nav>
        </header>
        
        <!-- Main Content -->
        <main class="dashboard-content">
            <div class="dashboard-header-row" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <h1 class="dashboard-title">Analytics Dashboard</h1>
                    <p class="dashboard-subtitle" id="regionSubtitle">Comprehensive overview of ARGO float oceanographic data</p>
                </div>
                <div class="region-selector" style="display: flex; align-items: center; gap: 0.75rem;">
                    <label for="regionSelect" style="color: var(--text-secondary); font-weight: 500;">Region:</label>
                    <select id="regionSelect" style="padding: 0.5rem 1rem; border-radius: var(--radius-md); background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 0.875rem; cursor: pointer; min-width: 180px;">
                        <option value="all">üåç All Regions</option>
                        <option value="bay_of_bengal">üåä Bay of Bengal</option>
                        <option value="arabian_sea">üåä Arabian Sea</option>
                        <option value="indian_ocean">üåä Indian Ocean</option>
                        <option value="pacific">üåä Pacific Ocean</option>
                        <option value="atlantic">üåä Atlantic Ocean</option>
                        <option value="mediterranean">üåä Mediterranean Sea</option>
                    </select>
                </div>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="overview-card temp">
                    <div class="overview-icon">üå°Ô∏è</div>
                    <div class="overview-label">Average Temperature</div>
                    <div class="overview-value" id="avgTemp">--¬∞C</div>
                    <div class="overview-change positive" id="tempChange">
                        <span>‚Üë</span> Loading...
                    </div>
                </div>
                
                <div class="overview-card sal">
                    <div class="overview-icon">üß™</div>
                    <div class="overview-label">Average Salinity</div>
                    <div class="overview-value" id="avgSal">-- PSU</div>
                    <div class="overview-change" id="salChange">
                        Loading...
                    </div>
                </div>
                
                <div class="overview-card floats">
                    <div class="overview-icon">üîµ</div>
                    <div class="overview-label">Active Floats</div>
                    <div class="overview-value" id="floatCount">--</div>
                    <div class="overview-change positive" id="floatChange">
                        Across Indian Ocean region
                    </div>
                </div>
                
                <div class="overview-card depth">
                    <div class="overview-icon">‚¨áÔ∏è</div>
                    <div class="overview-label">Max Depth Recorded</div>
                    <div class="overview-value" id="maxDepth">-- m</div>
                    <div class="overview-change" id="depthChange">
                        Pressure profiles available
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Temperature Distribution</div>
                            <div class="chart-subtitle">Sea surface temperature histogram</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tempDistChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Salinity Distribution</div>
                            <div class="chart-subtitle">Practical salinity unit histogram</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salDistChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Data Collection Timeline</div>
                            <div class="chart-subtitle">Monthly observation counts</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Regional Coverage</div>
                            <div class="chart-subtitle">Data distribution by ocean region</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="activity-section">
                <h2 class="activity-title">üìä Data Summary</h2>
                <div class="activity-list" id="activityList">
                    <div class="activity-item">
                        <div class="activity-icon">üåä</div>
                        <div class="activity-content">
                            <div class="activity-text">Loading database statistics...</div>
                            <div class="activity-time">Please wait</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Theme Management
        const THEME_KEY = 'floatchart_theme';
        
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
            applyTheme(savedTheme);
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
            
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (sunIcon && moonIcon) {
                sunIcon.style.display = theme === 'dark' ? 'block' : 'none';
                moonIcon.style.display = theme === 'light' ? 'block' : 'none';
            }
        }
        
        document.getElementById('themeToggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            applyTheme(current === 'dark' ? 'light' : 'dark');
        });
        
        initTheme();
        
        // Chart configurations
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        };
        
        // Store chart instances for updating
        let tempChart = null;
        let salChart = null;
        let timelineChart = null;
        let regionChart = null;
        
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                text: isDark ? '#94a3b8' : '#64748b',
                grid: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
                primary: '#3b82f6',
                secondary: '#06b6d4',
                accent: '#8b5cf6'
            };
        }
        
        // Region selector handler
        document.getElementById('regionSelect').addEventListener('change', async (e) => {
            const region = e.target.value;
            await loadDashboardData(region);
        });
        
        // Fetch dashboard data
        async function loadDashboardData(region = 'all') {
            try {
                // Show loading state
                document.getElementById('avgTemp').innerHTML = '<span class="skeleton" style="display:inline-block;width:60px;height:24px;"></span>';
                document.getElementById('avgSal').innerHTML = '<span class="skeleton" style="display:inline-block;width:60px;height:24px;"></span>';
                document.getElementById('floatCount').innerHTML = '<span class="skeleton" style="display:inline-block;width:60px;height:24px;"></span>';
                
                // Fetch status first
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                
                // Update activity summary
                updateActivitySummary(statusData);
                
                // Fetch real dashboard stats with region filter
                const statsResponse = await fetch(`/api/dashboard/stats?region=${region}`);
                const stats = await statsResponse.json();
                
                // Update region subtitle
                document.getElementById('regionSubtitle').textContent = 
                    stats.region ? `Statistics for ${stats.region}` : 'Comprehensive overview of ARGO float oceanographic data';
                
                if (stats.overview) {
                    // Update overview cards with REAL data
                    document.getElementById('avgTemp').textContent = `${stats.overview.avg_temperature}¬∞C`;
                    document.getElementById('avgSal').textContent = `${stats.overview.avg_salinity} PSU`;
                    document.getElementById('floatCount').textContent = stats.overview.float_count.toLocaleString();
                    document.getElementById('floatChange').textContent = `${stats.overview.total_records.toLocaleString()} total records`;
                    document.getElementById('maxDepth').textContent = `${Math.round(stats.overview.max_depth).toLocaleString()} m`;
                }
                
                // Load/Update charts with real data
                await loadCharts(stats);
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }
        
        function updateActivitySummary(data) {
            const activityList = document.getElementById('activityList');
            
            const activities = [
                {
                    icon: 'üìä',
                    text: `Total Records: ${data.records?.toLocaleString() || 'N/A'}`,
                    time: 'In database'
                },
                {
                    icon: 'üîµ',
                    text: `Unique ARGO Floats: ${data.unique_floats?.toLocaleString() || 'N/A'}`,
                    time: 'Tracked floats'
                },
                {
                    icon: 'üìÖ',
                    text: `Data Range: ${data.data_range?.start || 'N/A'} to ${data.data_range?.end || 'N/A'}`,
                    time: 'Temporal coverage'
                },
                {
                    icon: 'üåç',
                    text: 'Coverage: Indian Ocean, Bay of Bengal, Arabian Sea',
                    time: 'Geographic region'
                },
                {
                    icon: '‚úÖ',
                    text: `Database Status: ${data.database === 'connected' ? 'Connected' : 'Disconnected'}`,
                    time: data.status || 'Unknown'
                }
            ];
            
            activityList.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon">${a.icon}</div>
                    <div class="activity-content">
                        <div class="activity-text">${a.text}</div>
                        <div class="activity-time">${a.time}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadCharts(stats) {
            const colors = getChartColors();
            
            // Destroy existing charts before recreating
            if (tempChart) tempChart.destroy();
            if (salChart) salChart.destroy();
            
            // Temperature Distribution with REAL data
            const tempLabels = ['20-22', '22-24', '24-26', '26-28', '28-30', '30+'];
            const tempData = stats?.temperature_distribution 
                ? tempLabels.map(label => stats.temperature_distribution[label] || 0)
                : [15, 35, 80, 120, 95, 45];
            
            tempChart = new Chart(document.getElementById('tempDistChart'), {
                type: 'bar',
                data: {
                    labels: tempLabels,
                    datasets: [{
                        data: tempData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Temperature (¬∞C)', color: colors.text },
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        },
                        y: { 
                            title: { display: true, text: 'Count', color: colors.text },
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        }
                    }
                }
            });
            
            // Salinity Distribution with REAL data
            const salLabels = ['33-34', '34-35', '35-36', '36-37'];
            const salData = stats?.salinity_distribution
                ? salLabels.map(label => stats.salinity_distribution[label] || 0)
                : [45, 80, 150, 85];
                
            salChart = new Chart(document.getElementById('salDistChart'), {
                type: 'bar',
                data: {
                    labels: salLabels,
                    datasets: [{
                        data: salData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Salinity (PSU)', color: colors.text },
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        },
                        y: { 
                            title: { display: true, text: 'Count', color: colors.text },
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        }
                    }
                }
            });
            
            // Timeline - only create once
            if (!timelineChart) {
                timelineChart = new Chart(document.getElementById('timelineChart'), {
                    type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        data: [120, 145, 180, 210, 195, 220, 250, 235, 205, 180, 160, 140],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#06b6d4'
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        x: { 
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        },
                        y: { 
                            title: { display: true, text: 'Observations', color: colors.text },
                            ticks: { color: colors.text },
                            grid: { color: colors.grid }
                        }
                    }
                }
            });
            }
            
            // Regional Coverage - only create once
            if (!regionChart) {
                regionChart = new Chart(document.getElementById('regionChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Bay of Bengal', 'Arabian Sea', 'Central Indian Ocean', 'Other'],
                    datasets: [{
                        data: [35, 30, 25, 10],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(100, 116, 139, 0.8)'
                        ],
                        borderColor: 'transparent',
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartDefaults,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
            }
        }
        
        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</body>
</html>
